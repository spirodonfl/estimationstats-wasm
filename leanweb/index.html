<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DABEST via Pyodide</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>


<script src="https://cdn.jsdelivr.net/pyodide/v0.28.3/full/pyodide.js"></script>
<script>
// Loading progress tracking
const loader = {
  get element() { return document.getElementById('pyodide-loader'); },
  get status() { return document.getElementById('loader-status'); },
  get progress() { return document.getElementById('loader-progress'); },
  get percent() { return document.getElementById('loader-percent'); },
  get details() { return document.getElementById('loader-details'); },
  
  update(percent, status, details) {
    this.progress.style.width = percent + '%';
    this.percent.textContent = Math.round(percent) + '%';
    if (status) this.status.textContent = status;
    if (details) this.details.textContent = details;
  },
  
  hide() {
    this.element.style.opacity = '0';
    this.element.style.transition = 'opacity 0.5s ease';
    setTimeout(() => {
      this.element.remove();
    }, 500);
  }
};

async function loadPyodideRuntime() {
  try {
    // Hide the start button and show the loader
    document.getElementById('start-pyodide-btn').style.display = 'none';
    document.getElementById('pyodide-loader').style.display = 'block';
    
    loader.update(5, 'Loading Pyodide core...', 'Downloading WASM runtime');
    // Small delay to ensure UI updates before heavy loading starts
    await new Promise(r => setTimeout(r, 100));
    const pyodide = await loadPyodide();
  loader.update(20, 'Loading Python packages...', 'numpy, pandas, matplotlib, scipy, statsmodels, tqdm');

  await pyodide.loadPackage([
    "numpy","pandas","matplotlib","scipy","statsmodels","tqdm"
  ]);
  loader.update(40, 'Loading micropip...', 'Package installer');

  await pyodide.loadPackage("micropip");
  loader.update(50, 'Installing seaborn...', 'Data visualization library');
  await pyodide.runPythonAsync(`
import micropip
# install seaborn but don't re-resolve deps (matplotlib stays 3.8.4)
await micropip.install("seaborn", deps=False)
print("seaborn installed")
`);

  // lqrt (for latest dabest); harmless if already installed
  loader.update(60, 'Installing lqrt...', 'Optional dependency');
  await pyodide.runPythonAsync(`
import micropip
try:
    await micropip.install("lqrt")
    print("lqrt installed")
except Exception as e:
    print("lqrt not available:", e)
  `);

  // numba stub (no-op decorators)
  loader.update(70, 'Setting up numba compatibility...', 'Performance optimization stubs');
  await pyodide.runPythonAsync(`
import sys, types
m = types.ModuleType("numba")
def _noop(*dargs, **dkwargs):
    if dargs and callable(dargs[0]) and not dkwargs: return dargs[0]
    def deco(fn): return fn
    return deco
m.njit = m.jit = m.vectorize = m.guvectorize = _noop
m.prange = range
sys.modules["numba"] = m
  `);

  // Install dabest without trying to upgrade matplotlib
  loader.update(80, 'Installing DABEST...', 'Estimation statistics library');
  await pyodide.runPythonAsync(`
import micropip
await micropip.install("dabest", deps=False, reinstall=True)
  `);

  // Matplotlib backend target
  loader.update(85, 'Configuring matplotlib...', 'Setting up plotting backend');
  await pyodide.runPythonAsync(`
from js import document
#import matplotlib
#matplotlib.use("module://matplotlib_pyodide.html5_canvas_backend")
document.pyodideMplTarget = document.getElementById("plot-target")
  `);

  loader.update(90, 'Setting up compatibility layers...', 'Matplotlib and numba patches');
await pyodide.runPythonAsync(`
# Matplotlib compatibility shim for older versions (<=3.9)
import matplotlib
from matplotlib.axes import Axes

_original_violinplot = Axes.violinplot

def _violinplot_shim(self, dataset, *args, **kwargs):
    # DABEST (new) may pass orientation="vertical"/"horizontal"
    if "orientation" in kwargs and "vert" not in kwargs:
        orient = kwargs.pop("orientation")
        kwargs["vert"] = (orient == "vertical")
    return _original_violinplot(self, dataset, *args, **kwargs)

Axes.violinplot = _violinplot_shim
print("Patched Axes.violinplot to accept orientation -> vert")
`);
  // 5) Your demo
  loader.update(95, 'Running initialization demo...', 'Testing DABEST functionality');
  const out = await pyodide.runPythonAsync(`
import numpy as np, pandas as pd, dabest, matplotlib.pyplot as plt
import matplotlib

# (optional but explicit)
matplotlib.use("webagg")

np.random.seed(0)
df = pd.DataFrame({
    "group": np.repeat(["control","treat"], 50),
    "value": np.r_[np.random.normal(0,1,50), np.random.normal(0.6,1,50)]
})

d = dabest.load(df, x="group", y="value", idx=("control","treat"), ci=95)
est = d.mean_diff

print(est)

fig = est.plot(raw_label="value", contrast_label="mean diff")  # or swarm_label="value"
plt.title("DABEST in Pyodide")
plt.tight_layout()
plt.show()
  `);
  document.getElementById("out").textContent = out;
  
  // Hide loader when everything is ready
  loader.update(100, 'Ready!', 'Pyodide runtime loaded successfully');
  setTimeout(() => {
    loader.hide();
  }, 500);
  } catch (error) {
    console.error('Error loading Pyodide:', error);
    loader.update(0, 'Error loading Pyodide', error.message);
  }
}
</script>

<!-- Content Router for GitHub Pages -->
<script>
(function() {
  'use strict';
  
  // Content router configuration
  const INITIAL_PATH = window.location.pathname;
  const BASE_PATH = (() => {
    let path = INITIAL_PATH;
    if (path.endsWith('index.html')) {
      path = path.substring(0, path.lastIndexOf('/') + 1);
    }
    if (!path.endsWith('/')) {
      path = path + '/';
    }
    if (path === '/') {
      return './';
    }
    return path;
  })();
  
  console.log('BASE_PATH:', BASE_PATH, 'INITIAL_PATH:', INITIAL_PATH);
  
  const getBasePath = () => BASE_PATH;
  
  const getAssetPath = (relativePath) => {
    const base = getBasePath();
    const cleanPath = relativePath.replace(/^\.\//, '');
    return base + cleanPath;
  };
  const DEFAULT_CONTENT = 'default';
  
  function getCurrentRoute() {
    let path = sessionStorage.getItem('__original_path');
    if (path) {
      const search = sessionStorage.getItem('__original_search') || '';
      const hash = sessionStorage.getItem('__original_hash') || '';
      history.replaceState(null, '', path + search + hash);
      sessionStorage.removeItem('__original_path');
      sessionStorage.removeItem('__original_search');
      sessionStorage.removeItem('__original_hash');
    } else {
      path = window.location.pathname;
    }
    
    if (path === '/' || path === '/index.html') {
      return DEFAULT_CONTENT;
    }
    
    let route = path;
    if (BASE_PATH !== './' && BASE_PATH !== '/') {
      if (route.startsWith(BASE_PATH)) {
        route = route.substring(BASE_PATH.length);
      }
    } else if (BASE_PATH === '/') {
      route = route.replace(/^\//, '');
    } else {
      route = route.replace(/^\//, '');
    }
    
    route = route.replace(/\.html$/, '');
    route = route.replace(/\/$/, '');
    
    if (!route || route === '') {
      return DEFAULT_CONTENT;
    }
    
    return route;
  }
  
  function extractContent(htmlString) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlString, 'text/html');
    
    const result = {
      html: '',
      styles: [],
      scripts: []
    };
    
    const bodyContent = doc.body;
    const contentContainer = bodyContent.querySelector('[data-content]') || bodyContent;
    
    const styleTags = doc.querySelectorAll('style');
    styleTags.forEach(style => {
      result.styles.push(style.textContent || style.innerHTML);
    });
    
    const scriptTags = doc.querySelectorAll('script:not([src])');
    scriptTags.forEach(script => {
      result.scripts.push(script.textContent || script.innerHTML);
    });
    
    const externalScripts = doc.querySelectorAll('script[src]');
    externalScripts.forEach(script => {
      result.scripts.push({ src: script.src, type: 'external' });
    });
    
    result.html = contentContainer.innerHTML;
    
    return result;
  }
  
  function injectStyles(styles) {
    styles.forEach((styleContent, index) => {
      const styleId = `__injected_style_${Date.now()}_${index}`;
      const oldStyle = document.getElementById(styleId);
      if (oldStyle) {
        oldStyle.remove();
      }
      
      const style = document.createElement('style');
      style.id = styleId;
      style.textContent = styleContent;
      document.head.appendChild(style);
    });
  }
  
  function executeScripts(scripts) {
    scripts.forEach((scriptContent, index) => {
      if (typeof scriptContent === 'object' && scriptContent.type === 'external') {
        const script = document.createElement('script');
        script.src = scriptContent.src;
        script.async = true;
        document.head.appendChild(script);
      } else {
        try {
          const script = document.createElement('script');
          script.textContent = scriptContent;
          document.head.appendChild(script);
        } catch (e) {
          console.error('Error executing script:', e);
        }
      }
    });
  }
  
  async function loadContent(route) {
    const basePath = getBasePath();
    const contentFile = `${basePath}content/${route}.html`;
    
    console.log('loadContent - route:', route, 'basePath:', basePath, 'contentFile:', contentFile);
    
    try {
      const mainContent = document.querySelector('.main-content') || document.getElementById('app');
      if (mainContent) {
        mainContent.style.opacity = '0.5';
      }
      
      const response = await fetch(contentFile);
      
      if (!response.ok) {
        throw new Error(`Failed to load ${contentFile}: ${response.status}`);
      }
      
      const html = await response.text();
      const content = extractContent(html);
      
      injectStyles(content.styles);
      
      if (mainContent) {
        mainContent.innerHTML = content.html;
        mainContent.style.opacity = '1';
      }
      
      setTimeout(() => {
        executeScripts(content.scripts);
      }, 10);
      
    } catch (error) {
      console.error('Error loading content:', error);
      
      if (route !== DEFAULT_CONTENT) {
        console.log(`Trying to load default content...`);
        loadContent(DEFAULT_CONTENT);
      } else {
        const mainContent = document.querySelector('.main-content') || document.getElementById('app');
        if (mainContent) {
          mainContent.innerHTML = `
            <div style="padding: 20px; text-align: center;">
              <h2>Content Not Found</h2>
              <p>The requested content could not be loaded.</p>
              <p><a href="/">Return to home</a></p>
            </div>
          `;
          mainContent.style.opacity = '1';
        }
      }
    }
  }
  
  function handleNavigation() {
    const route = getCurrentRoute();
    loadContent(route);
  }
  
  function initRouter() {
    const mainContent = document.querySelector('.main-content') || document.getElementById('app');
    if (!mainContent) {
      console.warn('Router: No main-content area found, skipping routing');
      return;
    }
    
    const route = getCurrentRoute();
    // Don't load external content for the default route - index.html already has the content
    if (route === DEFAULT_CONTENT) {
      console.log('Router: On default route, keeping existing content');
      return;
    }
    handleNavigation();
    
    window.addEventListener('popstate', handleNavigation);
    
    document.addEventListener('click', function(e) {
      const link = e.target.closest('a[href]');
      if (!link || !link.href) {
        return;
      }
      
      if (link.target === '_blank' || link.href.startsWith('http') && !link.href.startsWith(window.location.origin)) {
        return;
      }
      
      try {
        const url = new URL(link.href, window.location.origin);
        if (url.origin !== window.location.origin) {
          return;
        }
        
        let path = url.pathname;
        const originalPath = path;
        const hash = url.hash;
        const search = url.search;
        
        const isStaticAsset = path.match(/\.(html|css|js|png|jpg|jpeg|gif|svg|pdf|json|woff|woff2|ttf|eot|otf)$/i);
        
        if (path.startsWith('/') && !path.startsWith(BASE_PATH) && BASE_PATH !== '/' && BASE_PATH !== './') {
          path = BASE_PATH + path.substring(1);
        }
        
        if (originalPath === '/' || originalPath === '/index.html' || path === BASE_PATH || path === BASE_PATH + 'index.html') {
          e.preventDefault();
          e.stopPropagation();
          const homePath = BASE_PATH === './' ? '/' : BASE_PATH;
          history.pushState(null, '', homePath + search + hash);
          handleNavigation();
          return;
        }
        
        if (!isStaticAsset && path !== '/' && path !== '/index.html') {
          e.preventDefault();
          e.stopPropagation();
          if (originalPath.startsWith('/') && !originalPath.startsWith(BASE_PATH) && BASE_PATH !== '/' && BASE_PATH !== './') {
            path = BASE_PATH + originalPath.substring(1);
          }
          history.pushState(null, '', path + search + hash);
          handleNavigation();
          return;
        }
      } catch (err) {
        console.warn('Error parsing link URL:', err);
      }
    }, true);
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initRouter);
  } else {
    initRouter();
  }
})();
</script>

<!-- Main Page Content -->
<div class="container">
  <div id="app">

    <header>
      <nav class="breadcrumb">
        <a href="./" class="breadcrumb-item black-text">Estimation stats</a>
        /
        <a href="./analyze" class="breadcrumb-item black-text">Plot</a>
      </nav>
      <div class="divider heavy"></div>
    </header>

    <div class="main-content">

      <div class="page-title">Welcome to DABEST</div>

      <div class="row">
        <div class="col content">
          <p>Data Analysis using Bootstrap-coupled ESTimation (DABEST) is a statistical tool for estimation statistics.</p>
          <p>Navigate to other pages to see dynamic content loading in action.</p>
        </div>
      </div>

      <!-- Pyodide Results Section -->
      <div id="pyodide-section" style="text-align: center; margin: 40px 0;">
        <!-- Start Button -->
        <button id="start-pyodide-btn" class="btn btn-large" onclick="loadPyodideRuntime()" style="background-color: #4CAF50; color: white; padding: 15px 30px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer;">
          Load DABEST Runtime
        </button>

        <!-- Pyodide Loading Bar (hidden by default) -->
        <div id="pyodide-loader" style="display: none; width: 100%; max-width: 600px; margin: 20px auto; padding: 20px; text-align: center; font-family: Arial, sans-serif; background: #f9f9f9; border-radius: 8px; border: 1px solid #e0e0e0;">
          <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">Loading Pyodide Runtime</h3>
          <div id="loader-status" style="margin-bottom: 10px; color: #666; font-size: 14px;">Initializing...</div>
          <div style="width: 100%; height: 24px; background: #e0e0e0; border-radius: 12px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
            <div id="loader-progress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4CAF50, #45a049); transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
              <span id="loader-percent">0%</span>
            </div>
          </div>
          <div id="loader-details" style="margin-top: 8px; color: #999; font-size: 12px; min-height: 18px;"></div>
        </div>

        <!-- Plot output -->
        <div id="plot-target" style="margin: 20px auto; max-width: 800px;"></div>

        <!-- Text output -->
        <pre id="out" style="text-align: left; max-width: 800px; margin: 20px auto; background: #f5f5f5; padding: 15px; border-radius: 8px; overflow-x: auto;"></pre>
      </div>

      <!-- Navigation Links -->
      <div class="row" style="margin-top: 40px;">
        <div class="col content">
          <h3>Explore</h3>
          <ul style="font-size: 1.25rem;">
            <li><a href="./sample">Sample Page</a></li>
            <li><a href="./demo">Demo Page</a></li>
          </ul>
        </div>
      </div>

    </div>

    <footer>
      <div class="row"></div>
      <div class="row valign-wrapper">
        <div class="col s2 left-align">
          <a href="./" class="grey-text text-darken-1">
            <img src="./img/Box.baa1019b.svg" class="logo" style="width: 200px; height: 200px;">
          </a>
        </div>
        <div class="col s3 center-align">
          <a href="https://acclab.github.io/DABEST-python/" class="grey-text text-darken-1">
            <img src="./img/DABEST.43a09767.svg" class="logo" style="width: 160px; height: auto;">
          </a>
        </div>
        <div class="col s3 center-align">
          <a href="https://acclab.github.io/dabestr/" class="grey-text text-darken-1">
            <img src="./img/dabestr.dfe30d65.svg" class="logo" style="width: 160px; height: auto;">
          </a>
        </div>
        <div class="col s3 center-align">
          <a href="./about" class="grey-text text-darken-1">
            <img src="./img/WebApp.db612c94.svg" class="logo" style="width: 160px; height: auto;">
          </a>
        </div>
      </div>
    </footer>

  </div>
</div>

</body>
</html>
